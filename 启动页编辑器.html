<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收藏夹编辑器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="编辑器.css">

</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1><i class="fas fa-bookmark"></i> 收藏夹编辑器</h1>
            <p>创建并管理您的个性化收藏夹网页，轻松添加、编辑和整理常用链接</p>
        </div>
        
        <!-- 拖放区域 - 缩小版 -->
        <div class="drop-zone" id="dropZone">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>拖放HTML文件到此处</h3>
            <p>或点击选择文件开始编辑现有收藏夹</p>
            <button class="btn-outline">
                <i class="fas fa-file-upload"></i> 选择文件
            </button>
            <input type="file" id="fileInput" accept=".html" style="display: none;">
        </div>
        
        <!-- 主编辑区 -->
        <div class="editor-container">
            <!-- 预览面板 -->
            <div class="preview-panel">
                <h2><i class="fas fa-eye"></i> 预览</h2>
                <div class="favorites-container" id="previewContent">
                    <!-- 预览内容将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- 编辑面板 -->
            <div class="edit-panel">
                <!-- 区域管理 -->
                <div class="section-editor">
                    <div class="section-header">
                        <h3><i class="fas fa-folder"></i> 区域管理</h3>
                        <div class="section-controls">
                            <button id="addSectionBtn">
                                <i class="fas fa-plus"></i> 添加区域
                            </button>
                        </div>
                    </div>
                    
                    <div id="sectionList">
                        <!-- 区域将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 按钮管理 -->
                <div class="section-editor">
                    <div class="section-header">
                        <h3><i class="fas fa-link"></i> 按钮管理</h3>
                        <div class="section-controls">
                            <button id="addButtonBtn">
                                <i class="fas fa-plus"></i> 添加按钮
                            </button>
                        </div>
                    </div>
                    
                    <!-- 区域筛选器 -->
                    <div class="section-filter">
                        <label>筛选区域:</label>
                        <select id="sectionFilter">
                            <option value="all">所有区域</option>
                            <!-- 区域选项将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    
                    <div class="button-list" id="buttonList">
                        <!-- 按钮将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 输出区域 -->
        <div class="output-container">
            <div class="output-header">
                <h3><i class="fas fa-code"></i> 生成的HTML代码</h3>
                <div class="section-controls">
                    <button class="btn-success" id="generateBtn">
                        <i class="fas fa-sync-alt"></i> 生成代码
                    </button>
                </div>
            </div>
            
            <textarea id="htmlOutput" readonly></textarea>
            
            <div class="btn-group">
                <button class="btn-info" id="copyBtn">
                    <i class="fas fa-copy"></i> 复制到剪贴板
                </button>
                <button class="btn-outline" id="resetBtn">
                    <i class="fas fa-redo"></i> 重置编辑器
                </button>
            </div>
        </div>
        
        <!-- 页脚 -->
        <div class="footer">
            <p>© 2023 收藏夹编辑器 | 轻松创建和管理您的个人收藏夹</p>
        </div>
    </div>

    <script>
        // 数据结构
        let sections = [
            {
                id: 'docs',
                title: '文档',
                icon: 'fas fa-file-alt',
                description: '常用文档资源'
            },
            {
                id: 'tools',
                title: '工具',
                icon: 'fas fa-tools',
                description: '实用在线工具'
            }
        ];
        
        let buttons = [
            {
                id: 'doc1',
                section: 'docs',
                title: 'MDN文档',
                content: 'Web开发技术文档',
                icon: 'fab fa-md',
                link: 'https://developer.mozilla.org/'
            },
            {
                id: 'doc2',
                section: 'docs',
                title: 'GitHub',
                content: '代码托管平台',
                icon: 'fab fa-github',
                link: 'https://github.com/'
            },
            {
                id: 'tool1',
                section: 'tools',
                title: 'JSON格式化',
                content: '在线JSON工具',
                icon: 'fas fa-code',
                link: 'https://jsonformatter.org/'
            },
            {
                id: 'tool2',
                section: 'tools',
                title: '颜色选择器',
                content: '在线颜色工具',
                icon: 'fas fa-palette',
                link: 'https://htmlcolorcodes.com/'
            }
        ];
        
        // 当前选中的区域和按钮
        let currentSection = null;
        let currentButton = null;
        let currentFilter = 'all'; // 当前筛选条件
        let hasUnsavedChanges = false; // 跟踪未保存的更改
        
        // 存储导入的HTML结构信息
        let importedHtmlStructure = {
            head: '',
            header: '',
            footer: '',
            styles: '',
            bodyClasses: '',
            containerClasses: ''
        };
        
        // 常用图标列表
        const commonIcons = [
            'fas fa-link', 'fas fa-file-alt', 'fas fa-book', 'fas fa-tools', 
            'fas fa-cog', 'fas fa-palette', 'fas fa-code', 'fas fa-image', 
            'fas fa-video', 'fas fa-music', 'fas fa-envelope', 'fas fa-calendar',
            'fas fa-map-marker', 'fas fa-globe', 'fas fa-database', 'fas fa-server',
            'fab fa-google', 'fab fa-github', 'fab fa-youtube', 'fab fa-twitter'
        ];
        
        // 标记有未保存的更改
        function markUnsavedChanges() {
            hasUnsavedChanges = true;
        }
        
        // 渲染区域列表
        function renderSections() {
            const container = document.getElementById('sectionList');
            container.innerHTML = '';
            
            sections.forEach(section => {
                const sectionEl = document.createElement('div');
                sectionEl.className = 'button-item';
                sectionEl.innerHTML = `
                    <div class="button-header">
                        <h4><i class="${section.icon}"></i> ${section.title}</h4>
                        <div class="button-actions">
                            <button class="btn-outline" onclick="editSection('${section.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-danger" onclick="deleteSection('${section.id}')" ${sections.length <= 1 ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p>${section.description || '暂无描述'}</p>
                `;
                container.appendChild(sectionEl);
            });
        }
        
        // 更新区域筛选器
        function updateSectionFilter() {
            const filter = document.getElementById('sectionFilter');
            // 保留"所有区域"选项
            const allOption = filter.querySelector('option[value="all"]');
            filter.innerHTML = '';
            filter.appendChild(allOption);
            
            // 添加区域选项
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = section.title;
                filter.appendChild(option);
            });
        }
        
        // 渲染按钮列表
        function renderButtons() {
            const container = document.getElementById('buttonList');
            container.innerHTML = '';
            
            // 根据筛选条件过滤按钮
            let filteredButtons = buttons;
            if (currentFilter !== 'all') {
                filteredButtons = buttons.filter(button => button.section === currentFilter);
            }
            
            if (filteredButtons.length === 0) {
                container.innerHTML = `
                    <div class="button-item" style="text-align: center; padding: 30px;">
                        <i class="fas fa-link" style="font-size: 3rem; color: #ddd; margin-bottom: 15px;"></i>
                        <h3>暂无按钮</h3>
                        <p>点击"添加按钮"开始创建</p>
                    </div>
                `;
                return;
            }
            
            filteredButtons.forEach(button => {
                const section = sections.find(s => s.id === button.section);
                const buttonEl = document.createElement('div');
                buttonEl.className = 'button-item';
                buttonEl.innerHTML = `
                    <div class="button-header">
                        <h4><i class="${button.icon}"></i> ${button.title}</h4>
                        <div class="button-actions">
                            <span class="tag" style="background: #eef2ff; color: #4a6cf7; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem;">
                                <i class="${section.icon}"></i> ${section.title}
                            </span>
                            <button class="btn-outline" onclick="editButton('${button.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-danger" onclick="deleteButton('${button.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p>${button.content}</p>
                    <a href="${button.link}" target="_blank" style="display: block; margin-top: 10px; color: #4a6cf7; font-size: 0.9rem;">
                        <i class="fas fa-external-link-alt"></i> ${button.link}
                    </a>
                `;
                container.appendChild(buttonEl);
            });
        }
        
        // 更新预览
        function updatePreview() {
            const previewContent = document.getElementById('previewContent');
            
            if (sections.length === 0) {
                previewContent.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: #6c757d;">
                        <i class="fas fa-bookmark" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.2;"></i>
                        <h3>暂无内容</h3>
                        <p>添加区域和按钮后，将在此处显示预览</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            sections.forEach(section => {
                const sectionButtons = buttons.filter(b => b.section === section.id);
                
                html += `
                    <section class="section">
                        <h2 class="section-title">
                            <i class="${section.icon}"></i> ${section.title}
                        </h2>
                        <div class="link-grid">
                `;
                
                if (sectionButtons.length === 0) {
                    html += `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 30px; background: #f8f9fa; border-radius: 10px;">
                            <i class="fas fa-link" style="font-size: 2.5rem; color: #ddd; margin-bottom: 15px;"></i>
                            <h3>此区域暂无按钮</h3>
                            <p>添加按钮后，将在此处显示</p>
                        </div>
                    `;
                } else {
                    sectionButtons.forEach(button => {
                        html += `
                            <div class="link-card">
                                <a href="${button.link}" target="_blank">
                                    <div class="link-icon">
                                        <i class="${button.icon}"></i>
                                    </div>
                                    <div class="link-content">
                                        <h3>${button.title}</h3>
                                        <p>${button.content}</p>
                                    </div>
                                </a>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                    </section>
                `;
            });
            
            previewContent.innerHTML = html;
        }
        
        // 显示区域表单
        function showSectionForm(section = null) {
            currentSection = section ? {...section} : null;
            
            const container = document.getElementById('sectionList');
            container.innerHTML = `
                <div class="button-item">
                    <h4><i class="fas fa-folder-plus"></i> ${section ? '编辑区域' : '添加新区域'}</h4>
                    <div class="form-group">
                        <label>区域名称</label>
                        <input type="text" id="sectionTitle" value="${section ? section.title : ''}" placeholder="例如：学习资源">
                    </div>
                    <div class="form-group">
                        <label>图标选择</label>
                        <div class="icon-selector">
                            ${commonIcons.map(icon => `
                                <div class="icon-option ${section && section.icon === icon ? 'selected' : ''}" data-icon="${icon}" onclick="selectIcon(this, 'section')">
                                    <i class="${icon}"></i>
                                </div>
                            `).join('')}
                        </div>
                        <input type="text" id="sectionIcon" value="${section ? section.icon : 'fas fa-folder'}" placeholder="例如：fas fa-book" style="margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>描述</label>
                        <input type="text" id="sectionDesc" value="${section ? section.description || '' : ''}" placeholder="区域简要描述">
                    </div>
                    <div class="btn-group">
                        <button class="btn-success" onclick="saveSection()">
                            <i class="fas fa-save"></i> 保存
                        </button>
                        <button class="btn-outline" onclick="renderSections()">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 选择图标
        function selectIcon(element, type) {
            const icon = element.getAttribute('data-icon');
            
            // 移除所有选中状态
            document.querySelectorAll(`.icon-option.selected`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // 设置当前选中
            element.classList.add('selected');
            
            // 更新输入框
            if (type === 'section') {
                document.getElementById('sectionIcon').value = icon;
            } else {
                document.getElementById('buttonIcon').value = icon;
            }
        }
        
        // 保存区域
        function saveSection() {
            const title = document.getElementById('sectionTitle').value.trim();
            const icon = document.getElementById('sectionIcon').value.trim();
            const description = document.getElementById('sectionDesc').value.trim();
            
            if (!title) {
                alert('请填写区域名称');
                return;
            }
            
            if (!icon) {
                alert('请选择图标');
                return;
            }
            
            if (currentSection) {
                // 更新现有区域
                const index = sections.findIndex(s => s.id === currentSection.id);
                if (index !== -1) {
                    sections[index] = {
                        ...sections[index],
                        title,
                        icon,
                        description
                    };
                }
            } else {
                // 添加新区域
                sections.push({
                    id: 'section' + Date.now(),
                    title,
                    icon,
                    description
                });
            }
            
            markUnsavedChanges();
            renderSections();
            updateSectionFilter();
            updatePreview();
        }
        
        // 编辑区域
        function editSection(sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (section) showSectionForm(section);
        }
        
        // 删除区域
        function deleteSection(sectionId) {
            if (sections.length <= 1) {
                alert('必须保留至少一个区域');
                return;
            }
            
            if (!confirm('确定要删除此区域吗？此操作将同时删除该区域下的所有按钮。')) {
                return;
            }
            
            // 删除区域
            sections = sections.filter(s => s.id !== sectionId);
            
            // 删除关联按钮
            buttons = buttons.filter(b => b.section !== sectionId);
            
            markUnsavedChanges();
            renderSections();
            updateSectionFilter();
            renderButtons();
            updatePreview();
        }
        
        // 显示按钮表单
        function showButtonForm(button = null) {
            currentButton = button ? {...button} : null;
            
            // 确定默认区域 - 修复部分：使用当前筛选的区域
            let defaultSection = currentFilter !== 'all' ? currentFilter : (sections.length > 0 ? sections[0].id : '');
            
            const container = document.getElementById('buttonList');
            container.innerHTML = `
                <div class="button-item">
                    <h4><i class="fas fa-plus-circle"></i> ${button ? '编辑按钮' : '添加新按钮'}</h4>
                    
                    <div class="form-group">
                        <label>所属区域</label>
                        <select id="buttonSection">
                            ${sections.map(s => 
                                `<option value="${s.id}" ${(button && button.section === s.id) || (!button && defaultSection === s.id) ? 'selected' : ''}>
                                    ${s.title}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>标题</label>
                            <input type="text" id="buttonTitle" value="${button ? button.title : ''}" placeholder="按钮标题">
                        </div>
                        <div class="form-group">
                            <label>图标选择</label>
                            <div class="icon-selector">
                                ${commonIcons.map(icon => `
                                    <div class="icon-option ${button && button.icon === icon ? 'selected' : ''}" data-icon="${icon}" onclick="selectIcon(this, 'button')">
                                        <i class="${icon}"></i>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="text" id="buttonIcon" value="${button ? button.icon : 'fas fa-link'}" placeholder="例如：fab fa-google" style="margin-top: 10px;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>描述</label>
                        <textarea id="buttonContent" rows="2" placeholder="按钮描述">${button ? button.content : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>链接地址</label>
                        <input type="text" id="buttonLink" value="${button ? button.link : ''}" placeholder="可以是任意内容">
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn-success" onclick="saveButton()">
                            <i class="fas fa-save"></i> 保存
                        </button>
                        <button class="btn-outline" onclick="renderButtons()">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 保存按钮
        function saveButton() {
            const section = document.getElementById('buttonSection').value;
            const title = document.getElementById('buttonTitle').value.trim();
            const icon = document.getElementById('buttonIcon').value.trim();
            const content = document.getElementById('buttonContent').value.trim();
            const link = document.getElementById('buttonLink').value.trim();
            
            if (!title) {
                alert('请填写按钮标题');
                return;
            }
            
            if (!icon) {
                alert('请选择图标');
                return;
            }
            
            if (!link) {
                alert('请输入链接地址');
                return;
            }
            
            if (currentButton) {
                // 更新现有按钮
                const index = buttons.findIndex(b => b.id === currentButton.id);
                if (index !== -1) {
                    buttons[index] = {
                        ...buttons[index],
                        section,
                        title,
                        icon,
                        content,
                        link
                    };
                }
            } else {
                // 添加新按钮
            buttons.push({
                id: 'button' + Date.now(),
                section,
                title,
                icon,
                content,
                link
            });
        }
        
        markUnsavedChanges();
        renderButtons();
        updatePreview();
    }
    
    // 编辑按钮
    function editButton(buttonId) {
        const button = buttons.find(b => b.id === buttonId);
        if (button) showButtonForm(button);
    }
    
    // 删除按钮
    function deleteButton(buttonId) {
        if (!confirm('确定要删除此按钮吗？')) {
            return;
        }
        
        buttons = buttons.filter(b => b.id !== buttonId);
        markUnsavedChanges();
        renderButtons();
        updatePreview();
    }
    
    // 提取HTML结构信息
    function extractHtmlStructure(doc) {
        // 提取head内容（除了title和viewport）
        const head = doc.head;
        let headContent = '';
        for (let i = 0; i < head.children.length; i++) {
            const child = head.children[i];
            if (child.tagName !== 'TITLE' && 
                !(child.tagName === 'META' && child.getAttribute('name') === 'viewport')) {
                headContent += child.outerHTML + '\n    ';
            }
        }
        
        // 提取header和footer内容
        const header = doc.querySelector('header');
        const footer = doc.querySelector('footer');
        
        // 提取body的class
        const bodyClasses = doc.body.getAttribute('class') || '';
        
        // 提取容器元素的class
        const container = doc.querySelector('.container');
        const containerClasses = container ? container.getAttribute('class') || '' : '';
        
        // 保存提取的信息
        importedHtmlStructure = {
            head: headContent,
            header: header ? header.outerHTML : '',
            footer: footer ? footer.outerHTML : '',
            styles: '',
            bodyClasses: bodyClasses,
            containerClasses: containerClasses
        };
    }
    
    // 生成输出HTML - 基于导入的HTML结构
    function generateOutput() {
        // 使用导入的HTML结构（如果有），否则使用默认结构
        let html = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的收藏夹</title>
    ${importedHtmlStructure.head || '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">'}
</head>
<body${importedHtmlStructure.bodyClasses ? ' class="' + importedHtmlStructure.bodyClasses + '"' : ''}>
    ${importedHtmlStructure.header || `
    <header>
        <h1><i class="fas fa-bookmark"></i> 我的收藏夹</h1>
        <p>精心整理的实用资源，提高工作效率</p>
    </header>
    `}
    
    <div${importedHtmlStructure.containerClasses ? ' class="' + importedHtmlStructure.containerClasses + '"' : ' class="container"'}>
        `;
        
        // 添加区域和按钮内容
        sections.forEach(section => {
            const sectionButtons = buttons.filter(b => b.section === section.id);
            
            html += `
        <section class="section">
            <h2 class="section-title">
                <i class="${section.icon}"></i> ${section.title}
            </h2>
            <div class="link-grid">
                `;
            
            sectionButtons.forEach(button => {
                html += `
                <div class="link-card">
                    <a href="${button.link}" target="_blank">
                        <div class="link-icon">
                            <i class="${button.icon}"></i>
                        </div>
                        <div class="link-content">
                            <h3>${button.title}</h3>
                            <p>${button.content}</p>
                        </div>
                    </a>
                </div>
                `;
            });
            
            html += `
            </div>
        </section>
            `;
        });
        
        // 添加页脚
        html += `
        ${importedHtmlStructure.footer || `
        <footer>
            <p>© 2023 我的收藏夹 | 最后更新: ${new Date().toLocaleDateString()}</p>
        </footer>
        `}
    </div>
</body>
</html>`;
        
        document.getElementById('htmlOutput').value = html;
    }
    
    // 复制到剪贴板
    function copyToClipboard() {
        const output = document.getElementById('htmlOutput');
        output.select();
        document.execCommand('copy');
        
        // 显示成功消息
        const originalText = document.getElementById('copyBtn').innerHTML;
        document.getElementById('copyBtn').innerHTML = '<i class="fas fa-check"></i> 已复制';
        setTimeout(() => {
            document.getElementById('copyBtn').innerHTML = originalText;
        }, 2000);
    }
    
    // 重置编辑器
    function resetEditor() {
        if (!confirm('确定要重置编辑器吗？所有未保存的更改将会丢失。')) {
            return;
        }
        
        sections = [
            {
                id: 'docs',
                title: '文档',
                icon: 'fas fa-file-alt',
                description: '常用文档资源'
            },
            {
                id: 'tools',
                title: '工具',
                icon: 'fas fa-tools',
                description: '实用在线工具'
            }
        ];
        
        buttons = [
            {
                id: 'doc1',
                section: 'docs',
                title: 'MDN文档',
                content: 'Web开发技术文档',
                icon: 'fab fa-md',
                link: 'https://developer.mozilla.org/'
            },
            {
                id: 'doc2',
                section: 'docs',
                title: 'GitHub',
                content: '代码托管平台',
                icon: 'fab fa-github',
                link: 'https://github.com/'
            },
            {
                id: 'tool1',
                section: 'tools',
                title: 'JSON格式化',
                content: '在线JSON工具',
                icon: 'fas fa-code',
                link: 'https://jsonformatter.org/'
            },
            {
                id: 'tool2',
                section: 'tools',
                title: '颜色选择器',
                content: '在线颜色工具',
                icon: 'fas fa-palette',
                link: 'https://htmlcolorcodes.com/'
            }
        ];
        
        // 重置导入的HTML结构
        importedHtmlStructure = {
            head: '',
            header: '',
            footer: '',
            styles: '',
            bodyClasses: '',
            containerClasses: ''
        };
        
        hasUnsavedChanges = false;
        currentFilter = 'all';
        renderSections();
        updateSectionFilter();
        renderButtons();
        updatePreview();
        document.getElementById('htmlOutput').value = '';
        document.getElementById('sectionFilter').value = 'all';
        
        // 重置拖放区域
        document.getElementById('dropZone').innerHTML = `
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>拖放HTML文件到此处</h3>
            <p>或点击选择文件开始编辑现有收藏夹</p>
            <button class="btn-outline">
                <i class="fas fa-file-upload"></i> 选择文件
            </button>
        `;
        
        // 重新绑定事件
        document.getElementById('dropZone').addEventListener('click', () => document.getElementById('fileInput').click());
    }
    
    // 设置拖拽上传
    function setupDragAndDrop() {
        const dropZone = document.getElementById('dropZone');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        dropZone.addEventListener('drop', handleDrop, false);
    }
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight() {
        document.getElementById('dropZone').classList.add('dragover');
    }
    
    function unhighlight() {
        document.getElementById('dropZone').classList.remove('dragover');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length) {
            handleFileSelect({ target: { files } });
        }
    }
    
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (file.type === 'text/html' || file.name.endsWith('.html')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 解析HTML文件内容
                    const content = e.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(content, 'text/html');
                    
                    // 提取HTML结构信息
                    extractHtmlStructure(doc);
                    
                    // 提取区域和按钮数据
                    const parsedSections = [];
                    const parsedButtons = [];
                    
                    // 查找所有区域
                    const sectionElements = doc.querySelectorAll('.section');
                    sectionElements.forEach(sectionEl => {
                        const titleEl = sectionEl.querySelector('.section-title');
                        if (titleEl) {
                            const iconEl = titleEl.querySelector('i');
                            const section = {
                                id: 'section' + Date.now() + Math.random().toString(36).substr(2, 5),
                                title: titleEl.textContent.trim(),
                                icon: iconEl ? iconEl.className : 'fas fa-folder',
                                description: ''
                            };
                            parsedSections.push(section);
                            
                            // 查找该区域下的所有按钮
                            const linkCards = sectionEl.querySelectorAll('.link-card');
                            linkCards.forEach(card => {
                                const linkEl = card.querySelector('a');
                                const iconEl = card.querySelector('.link-icon i') || card.querySelector('.link-icon');
                                const titleEl = card.querySelector('.link-content h3');
                                const contentEl = card.querySelector('.link-content p');
                                
                                if (linkEl && titleEl) {
                                    parsedButtons.push({
                                        id: 'button' + Date.now() + Math.random().toString(36).substr(2, 5),
                                        section: section.id,
                                        title: titleEl.textContent.trim(),
                                        content: contentEl ? contentEl.textContent.trim() : '',
                                        icon: iconEl ? (iconEl.className || 'fas fa-link') : 'fas fa-link',
                                        link: linkEl.getAttribute('href')
                                    });
                                }
                            });
                        }
                    });
                    
                    // 更新数据
                    if (parsedSections.length > 0) {
                        sections = parsedSections;
                        buttons = parsedButtons;
                        
                        // 更新UI
                        renderSections();
                        updateSectionFilter();
                        renderButtons();
                        updatePreview();
                        
                        document.getElementById('dropZone').innerHTML = `
                            <i class="fas fa-check-circle" style="color: #28a745;"></i>
                            <h3>已加载: ${file.name}</h3>
                            <p>开始编辑您的收藏夹</p>
                        `;
                        
                        hasUnsavedChanges = false;
                    } else {
                        alert('无法从文件中提取有效的收藏夹数据');
                    }
                } catch (error) {
                    console.error('解析文件时出错:', error);
                    alert('解析文件时出错，请确保文件格式正确');
                }
            };
            reader.readAsText(file);
        } else {
            alert('请上传HTML文件');
        }
    }
    
    // DOM加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化UI
        renderSections();
        updateSectionFilter();
        renderButtons();
        updatePreview();
        
        // 事件监听
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('dropZone').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('addSectionBtn').addEventListener('click', () => showSectionForm());
        document.getElementById('addButtonBtn').addEventListener('click', () => showButtonForm());
        document.getElementById('generateBtn').addEventListener('click', generateOutput);
        document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
        document.getElementById('resetBtn').addEventListener('click', resetEditor);
        document.getElementById('sectionFilter').addEventListener('change', function() {
            currentFilter = this.value;
            renderButtons();
        });
        
        // 设置拖拽上传
        setupDragAndDrop();
        
        // 监听页面关闭/刷新前的保存提示
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                const message = '您有未保存的更改，确定要离开吗？';
                e.returnValue = message;
                return message;
            }
        });
    });
</script>
</body>
</html>
